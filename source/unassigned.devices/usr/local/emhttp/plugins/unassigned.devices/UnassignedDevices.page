Menu="Main:4"
Title="Unassigned Devices"
Tag="unlink"
---
<?php
/* Copyright 2015, Guilherme Jardim
 * Copyright 2016-2025, Dan Landon
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */

/* Load the UD library file if it is not already loaded. */
require_once("plugins/unassigned.devices/include/lib.php");

/* See if NFS and SMB sharing is enabled. */
$disabled = (($var['shareNFSEnabled'] == "no") && ($var['shareSMBEnabled'] == "no")) ? "disabled" : "";

/* If user0 exists, then a user- root share is available. */
$isUser0	= is_dir("/mnt/user0/");
?>

<? if (is_file("usr/local/emhttp/plugins/dynamix.docker.manager/styles/style-$theme.css") ):?>
<link rel="stylesheet" href="<?autov("/plugins/dynamix.docker.manager/styles/style-$theme.css")?>">
<?endif;?>
<link rel="stylesheet" href="<?autov('/webGui/styles/jquery.switchbutton.css')?>">
<link rel="stylesheet" href="<?autov('/webGui/styles/jquery.filetree.css')?>">

<link rel="stylesheet" href="<?autov("/plugins/".UNASSIGNED_PLUGIN."/assets/style-$theme.css")?>">
<link rel="stylesheet" href="<?autov("/plugins/".UNASSIGNED_PLUGIN."/assets/unassigned.css")?>">

<script src="<?autov('/webGui/javascript/jquery.switchbutton.js')?>"></script>
<script src="<?autov('/webGui/javascript/jquery.filetree.js')?>"></script>

<script src="<?autov('/plugins/'.UNASSIGNED_PLUGIN.'/assets/arrive.min.js')?>"></script>

<style>
<?if ($themes1):?>
	div.title.ud{margin-top:-45px}
	div#title.ud{margin-top:-45px}
<?else:?>
	div.title.ud{margin-top:0}
	div#title.ud{margin-top:0}
<?endif;?>
</style>

<script>
	/* Initialize PHP variables passed to JavaScript */
	const udPluginPath = <?=UD_PLUGIN_PATH;?>;

	/* URL for Unassigned Devices PHP file. */
	const UDURL	= '/plugins/' + udPluginPath + '/include/UnassignedDevices.php';

	/* Display information from PHP on the client side. */
	const display = <?=json_encode($display);?>;

	/* Array to store network information. */
	let network = [];

	/* Page refresh timer. */
	let refreshTimer;

	/* Flag to track whether page is currently being refreshed. */
	let isRefreshing = false;

	/* Page refresh rate is 3 seconds. */
	const REFRESH_INTERVAL = 3000;

	/* Ping poll interval is 15 seconds. */
	const PING_INTERVAL = 15000;

	/*
		Helper function to update UI elements.
		@param selector: The element selector.
		@param className: The class to apply.
	*/
	function updateClass(selector, className) {
		document.getElementById(selector).className = className;
	}

	/*
		Function to initiate spinning down a disk.
		@param dev: The device identifier.
	*/
	function spinDownDisk(dev) {
		updateClass('disk_orb-' + dev, "fa fa-refresh fa-spin green-orb orb");
		ajaxRequest(UDURL, { action: 'spin_down_disk', device: dev });
	}

	/*
		Function to initiate spinning up a disk.
		@param dev: The device identifier.
	*/
	function spinUpDisk(dev) {
		updateClass('disk_orb-' + dev, "fa fa-refresh fa-spin grey-orb orb");
		ajaxRequest(UDURL, { action: 'spin_up_disk', device: dev });
	}

	/*
		Helper function to perform AJAX requests.
		@param url: The target URL for the request.
		@param data: The data to send in the request.
		@param method: The HTTP method, default is POST.
		@return: A promise for the AJAX request.
	*/
	function ajaxRequest(url, data, method = 'POST') {
		return $.ajax({
			url: url,
			type: method,
			data: data,
			dataType: 'json'
		});
	}

	/*
		Utility function to replace placeholders in a string with corresponding values from an object or arguments list.
		@param template: The template string containing placeholders like {key}.
		@param values: An object with key-value pairs or multiple arguments.
		@return: The formatted string.
	*/
	function formatString(template, values) {
		"use strict";

		/* Ensure the input is a string */
		let str = template.toString();

		/* Determine the type of the values parameter */
		const args = typeof values === "object" ? values : Array.from(arguments).slice(1);

		/* Replace placeholders with corresponding values */
		for (const key in args) {
			if (Object.prototype.hasOwnProperty.call(args, key)) {
				const pattern = new RegExp(`\\{${key}\\}`, "gi");
				str = str.replace(pattern, args[key]);
			}
		}

		return str;
	}

	/*
		Function to open a window for running fsck and script commands.
		@param cmd: The fsck command to run.
		@param title: The title for the window.
		@param height: The height of the window.
		@param width: The width of the window.
	*/
	function openWindowFsck(cmd, title, height, width) {
		const top = (screen.height - height) / 2;
		const left = (screen.width - width) / 2;

		/* Construct window options string */
		const options = `resizable=yes,scrollbars=yes,height=${height},width=${width},top=${top},left=${left}`;

		/* Open the window */
		window.open(cmd, title || 'log', options);
	}

	/*
		Function to perform disk operations based on the specified parameters.
		@param el: The element triggering the operation.
		@param op: The disk operation (e.g., "mount" or "unmount").
		@param device: The target device for the operation.
	*/
	async function diskOperation(el, op, device) {
		const mountButton = $(`button[device='${device}']`);

		/* Clear the page refresh timer. */
		window.clearInterval(refreshTimer);

		/* Add spinning icon to mount/unmount button and disable button. */
		mountButton.prop("disabled", true).html("<i class='fa fa-spinner fa-spin orb'></i>" + (op == "mount" ? "<?=_('Mounting');?>" : "<?=_('Unmounting');?>"));

		/* Check if refreshPage is already in progress. */
		if (isRefreshing) {
			try {
				/* Wait for the current refreshPage to complete before proceeding. */
				await refreshPage();
			} catch (error) {
				/*
					Ignore the error and initiate the post request anyway.
					This will occur if refreshPage() has completed and just returns without a resolved promise.
				*/
			}
		}

		/*
			Once the refresh is completed, the mount button status needs to be refreshed in case the refreshPage() cleared it.
			After the mount/unmount post is started, the mount status flag files will be set and the mount button status will be up to date.
		*/

		/* Refresh the mount/unmount button and disable button if the refreshPage() happened to change the status. */
		mountButton.prop("disabled", true).html("<i class='fa fa-spinner fa-spin orb'></i>" + (op == "mount" ? "<?=_('Mounting');?>" : "<?=_('Unmounting');?>"));

		/* Initiate the post request immediately. */
		await mountPostRequest(op, device);

		/* Restart the page refresh timer. */
		refreshTimer = window.setInterval(refreshPage, REFRESH_INTERVAL);
	}

	/* Perform the disk opertion. */
	async function mountPostRequest(op, device) {
		/* Start the refresh timer to refresh the page after the mount/unmount script starts. */
		window.setTimeout(refreshPage, 100);

		$.post(UDURL, {
			'action': op,
			'device': device
		})
		.done(data => {
			if (data === "false") {
				swalShowMountUnmount(device, op);
			}
		})
		.fail(() => {
			swalShowResult(false);
		})
		.always(() => {
			/* Start the refresh timer to refresh the page if it's not currently refreshing. */
			window.setTimeout(refreshPage, 100);
		});
	}

	/*
		Refresh UD page showing any updated information.
	*/
	async function refreshPage() {
		/* Exit if refresh is already in progress. */
 		if (isRefreshing) return;

		isRefreshing = true;

		const timeoutMessage = "<tr><td colspan='11' style='text-align:center;'><?=_('Timeout: Failed to get unassigned devices information - check the syslog');?>.</td></tr>";

		try {
			/* Fetch data with a timeout. */
			const data = await Promise.race([fetchUDContent(), createTimeoutPromise(30000, timeoutMessage)]);

			if (data) {
				updatePageContent(data);
			}
		} catch (error) {
			/* Handle errors and update page with error messages. */
			updatePageContent({ disks: error.message, remotes: error.message, historical: error.message });
		} finally {
			/* Reset the refreshing flag. */
 			isRefreshing = false;
		}
	}

	/*
		Helper function to fetch UD content via AJAX.
		@return: A promise that resolves with the fetched data or rejects on failure.
	*/
	function fetchUDContent() {
		const ajaxFailureMessage = "<tr><td colspan='11' style='text-align:center;'><?=_('Failed to get data to refresh page');?>.</td></tr>";

		return new Promise((resolve, reject) => {
			$.post(UDURL, { action: 'get_ud_content', display: display }, resolve, 'json')
				.fail(() => reject(new Error(ajaxFailureMessage)));
		});
	}

	/*
		Helper function to create a timeout promise.
		@param ms: Timeout duration in milliseconds.
		@param message: The message for the timeout error.
		@return: A promise that rejects after the specified timeout.
	*/
	function createTimeoutPromise(ms, message) {
		return new Promise((_, reject) => setTimeout(() => reject(new Error(message)), ms));
	}

	/*
		Helper function to update the UD page content.
		@param data: The data object containing disks, remotes, and historical content.
	*/
	function updatePageContent(data) {
		const toggled = $("tr.toggle-parts:visible").map(function () {
			return $(this).attr("name");
		}).get();

		$('#disk-table-body').html(data.disks);
		$('#remotes-table-body').html(data.remotes);
		$('#historical-table-body').html(data.historical);

		$.each(toggled, function (_, name) {
			$("tr[name='" + name + "']").css("display", "table-row");
		});
	}

	/*
		Poll remote servers and update ping status.
	*/
	function pingPoll() {
		$.post(UDURL, {
			'action': 'update_ping'
		});
	}

	/*
		Function to load hosts based on the specified parameters.
		@param el: The element triggering the action.
		@param action: The action to perform.
	*/
	function loadHosts(el, action) {
		const target = $(el).parents("div").find("*[name='IP']");
		const oldContent = $(el).html();

		/* Show a loading spinner while processing the request. */
		showLoadingSpinner(el, "<?=_('Searching');?>");

		/* Make an asynchronous request to load hosts. */
		$.post(UDURL, { action, network })
			.done((data) => {
				/* Restore the original content of the element. */
				$(el).html(oldContent);

				/* Update the target element with the retrieved hosts or fallback input. */
				updateHostsDropdown(target, data);
			});
	}

	/*
		Display a loading spinner with a message.
		@param el: The element to display the spinner on.
		@param message: The loading message.
	*/
	function showLoadingSpinner(el, message) {
		$(el).html(`<i class='fa fa-spinner fa-spin'></i> ${message}`);
	}

	/*
		Update the target element with a dropdown or input based on host data.
		@param target: The target element to update.
		@param data: The raw host data as a newline-separated string.
	*/
	function updateHostsDropdown(target, data) {
		if (data) {
			const hosts = data.split('\n').filter(host => host.trim().length > 0);

			if (hosts.length > 0) {
				/* Build a dropdown with the available hosts. */
				const dropdownOptions = hosts.map(host => `<option value='${host.trim()}'>${host.trim()}</option>`).join('');
				target.replaceWith(`<select name='IP' class='swal-content__input' required>${dropdownOptions}</select>`);
			} else {
				/* Fallback to a text input if no hosts are found. */
				target.replaceWith("<input type='text' name='IP' class='swal-content__input' autocomplete='off'>");
			}
		} else {
			/* Fallback to a text input if data is empty. */
			target.replaceWith("<input type='text' name='IP' class='swal-content__input' autocomplete='off'>");
		}
	}

	/*
		Function to load shares based on the specified parameters.
		@param el: The element triggering the action.
		@param ip: The IP address.
		@param user: The username.
		@param pass: The password.
		@param action: The action to perform.
	*/
	function loadShares(el, ip, user, pass, action) {
		const oldContent = $(el).html();
		const target = $(el).parents("div").find("*[name='SHARE']");

		/* Show a loading spinner while processing the request. */
		showLoadingSpinner(el, "<?=_('Loading');?>");

		/* Prepare POST request options. */
		const opts = {
			action,
			IP: ip,
			USER: user,
			PASS: pass
		};

		/* Make an asynchronous POST request to load shares. */
		$.post(UDURL, opts)
			.done((data) => {
				/* Restore the original content of the element. */
				$(el).html(oldContent);

				/* Update the target element with the retrieved shares or fallback input. */
				updateSharesDropdown(target, data);
			});
	}

	/*
		Update the target element with a dropdown or input based on share data.
		@param target: The target element to update.
		@param data: The raw share data as a newline-separated string.
	*/
	function updateSharesDropdown(target, data) {
		if (data) {
			const shares = data.split('\n').filter(share => share.trim().length > 0);

			if (shares.length > 0) {
				/* Build a dropdown with the available shares. */
				const dropdownOptions = shares.map(share => `<option value='${share}'>${share}</option>`).join('');
				target.replaceWith(`<select name='SHARE' class='swal-content__input' required>${dropdownOptions}</select>`);
			} else {
				/* Fallback to a text input if no shares are found. */
				target.replaceWith("<input type='text' name='SHARE' class='swal-content__input' autocomplete='off' required>");
			}
		} else {
			/* Fallback to a text input if data is empty. */
			target.replaceWith("<input type='text' name='SHARE' class='swal-content__input' autocomplete='off' required>");
		}
	}

	/*
		Function to display a SweetAlert2 notification based on the result of an operation.
		@param success: A boolean indicating whether the operation was successful.
	*/
	function swalShowResult(success) {
		const options = success
			? createSwalOptions("<?=_('Success');?>!", "success", " ", 2000)
			: createSwalOptions("<?=_('Fail');?>!", "error", "<p><?=_('Check the syslog for details');?>.</p>", 2000);

		swal2(options);
	}

	/*
		Helper function to create SweetAlert2 options.
		@param title: The title of the alert.
		@param icon: The icon type (e.g., "success" or "error").
		@param content: The content (HTML or plain text) for the alert.
		@param timer: The duration in milliseconds before the alert auto-closes.
		@return: An object with the configured SweetAlert2 options.
	*/
	function createSwalOptions(title, icon, content, timer) {
		return {
			title,
			icon,
			content: {
				element: "div",
				attributes: { innerHTML: content }
			},
			buttons: {
				confirm: { visible: false },
				cancel: { visible: false }
			},
			timer
		};
	}

	/*
		Function to display a SweetAlert2 notification for mount/unmount failure.
		@param device: The device that failed to mount/unmount.
		@param op: The operation (mount/unmount) that failed.
	*/
	function swalShowMountUnmount(device, op) {
		const content = `<p><?=_('Device');?> '${device}' <?=_('failed to');?> ${op}. </p><p><?=_('Check the syslog for details');?>.</p>`;
		const options = createSwalOptions("<?=_('Fail')?>!", "error", content, 3000);

		swal2(options);
	}

	/* Function to handle surveys for unassigned devices */
	function doUnassignedDevicesSurvey(surveyName, surveyOption) {
		/* Get the survey element by name */
		const survey = $("div[data-survey-name=" + surveyName + "]");

		/* Initialize the number of questions */
		let numQuestions = survey.find("div[data-question]").length;

		/* Initialize an array to store survey data */
		let surveyData = [];

		/* Initialize the index for question tracking */
		let index = 0;

		/* Function to evaluate a condition based on selector */
		const evalCondition = function (obj, selector) {
			let rc = null;
			if (obj.find(selector).length) {
				const evaled = $.trim(obj.find(selector).eq(0).text());
				if (evaled.length) {
					rc = eval(evaled);
				}
			}
			return rc;
		};

		/* Function to get attribute with a default value */
		const getAttr = function (obj, name, defaultValue) {
			/* Check if the attribute exists in the object */
			return (typeof obj.attr(name) !== "undefined") ? obj.attr(name) : defaultValue;
		};

		/* Function to display a Swal (SweetAlert) dialog for surveys */
		function showSwal(direction = "=") {
			switch (direction) {
				case '>':
					index++;
					break;

				case '<':
					index--;
					break;
			}

			if (index >= numQuestions) {
				return false;
			}

			/* Retrieve the current question and its condition */
			question = survey.find("div[data-question]").eq(index);
			condition = question.find("div[data-question-condition]").eq(0);

			/* Check if the condition is met, and recursively call showSwal if not */
			if (condition.length && !eval($.trim(condition.text()))) {
				showSwal(direction);
			}

			/* Get question content and format if necessary */
			content = question.find("div[data-question-content]").html();
			format = question.find("div[data-question-format]");

			if (format.length) {
				eval("formatOpts = " + $.trim(format.text()));
				content = formatString(content, formatOpts);
			}

			/* Update checked inputs based on surveyData */
			has_checked = ["checkbox", "radio", "option"];
			restore_content = $("<div></div>").html(content);
			restore_content.find(":input").each(function (i, v) {
				name = $(this).prop("name");
				if (name in surveyData) {
					if ($.inArray($(this).prop("type"), has_checked) != -1) {
						if ($(this).val() == surveyData[name]) {
							$(this).attr("checked", true);
						}
					} else {
						if ($(this).prop("type") == "select-one") {
							$(this).find("option[value=" + surveyData[name] + "]").attr("selected", true);
						} else {
							$(this).attr("value", surveyData[name]);
						}
					}
				}
			});

			content = restore_content[0].outerHTML;
			button = {
				back: getAttr(question, "data-question-button-back", "<?=_('Back')?>"),
				next: getAttr(question, "data-question-button-next", "<?=_('Next')?>"),
				done: getAttr(question, "data-question-button-done", "<?=_('Done')?>"),
				cancel: getAttr(question, "data-question-button-cancel", "<?=_('Cancel')?>")
			};

			/* Define SweetAlert options */
			swalOpts = new Object;
			swalOpts.title = question.attr("data-question-title");
			swalOpts.content = {element: "div", attributes: {innerHTML: content}};
			swalOpts.icon = getAttr(question, "data-question-icon", "info");
			swalOpts.closeOnClickOutside = false;
			swalOpts.buttons = new Object;
			swalOpts.buttons.next = (index == numQuestions - 1) ? {
				text: button.done,
				value: true,
				visible: true,
				className: "",
				closeModal: false
			} : {
				text: button.next,
				value: true,
				visible: true,
				className: "",
				closeModal: false
			};
			swalOpts.buttons.cancel = (index > 0) ? {
				text: button.back,
				value: false,
				visible: true,
				className: "",
				closeModal: false
			} : {
				text: button.cancel,
				value: null,
				visible: true,
				className: "",
				closeModal: true
			};
			swalOpts.buttons.confirm = (index > 0) ? {
				text: button.cancel,
				value: null,
				visible: true,
				className: "",
				closeModal: true
			} : {
				text: "",
				value: null,
				visible: false,
				className: "",
				closeModal: true
			};

			/* Display SweetAlert and handle responses */
			swal2(swalOpts).then((response) => {
				emptyInputs = $.grep($(".swal-modal").find(":input"), function (e, v) {
					e = $(e);
					switch (e.prop('type')) {
						case 'radio':
							if (e.is(":checked")) {
								surveyData[e.prop("name")] = e.val();
							}
							n = $(":input[name=" + e.prop("name") + "]");
							return (n.is("[required]") && !n.is(":checked"));
							break;

						case 'option':
						case 'checkbox':
							if (e.is(":checked")) {
								surveyData[e.prop("name")] = e.val()
							}
							return (e.is("[required]") && !e.is(":checked"));
							break;

						case 'select-one':
							if (e.has(":checked")) {
								surveyData[e.prop("name")] = e.find(":checked").val();
							}
							n = $(":input[name=" + e.prop("name") + "]");
							return (n.is("[required]") && !n.has(":checked"));
							break;

						default:
							if (e.val() || e.prop("name")) {
								surveyData[e.prop("name")] = e.val()
							}
							return (e.is("[required]") && !e.val());
							break;
					}
				});

				if (response) {
					if (emptyInputs.length) {
						return "=";
					} else if (!emptyInputs.length && index <= numQuestions - 1) {
						evaled = evalCondition(question, "div[data-question-done]");
						if (index < numQuestions - 1) {
							if (evaled !== null && evaled === true) {
								return ">";
							}

							if (evaled !== null && evaled === false) {
								return "<";
							} else {
								return ">";
							}
						} else if (index == numQuestions - 1) {
							if (evaled !== null && evaled === false) {
								return "=";
							} else {
								$(".swal-button--cancel").prop("disabled", true);
								$(".swal-button--confirm").prop("disabled", true);
								evalCondition(survey, "div[data-survey-done]");
								if (getAttr(survey.find("div[data-survey-done]").eq(0), "data-survey-done-wait", "true") == "false") {
									setTimeout(() => {
										swal2({buttons: {confirm: {visible: false}, cancel: {visible: false}}, timer: 100})
									}, 1500)
								}

								return true;
							}
						}
					} else {
						return "=";
					}
				} else if (response === false && index <= numQuestions) {
					return "<";
				} else if (response === null) {
					return true;
				}

				return "=";
			}).then((response2) => {
				if (typeof response2 !== "boolean") {
					return showSwal(response2);
				} else {
					return false;
				}
			});
		}

		/* Do the survey. */
		showSwal();
	}

	<?
	/* Loop through network interfaces (eth0 to eth10). */
	for ($i = 0; $i < 11; $i++) {
		$interfaceVariable = "eth{$i}";

		/* Check if the network interface variable is set and contains data. */
		if (isset($$interfaceVariable) && is_array($$interfaceVariable)) {
			$iface = $$interfaceVariable;

			/* Extract gateway, IP address, and netmask information. */
			$gateway = array_values(array_flip(preg_grep("/GATEWAY:/", array_flip($iface))));
			$ipaddr = array_values(array_flip(preg_grep("/IPADDR:/", array_flip($iface))));
			$netmask = array_values(array_flip(preg_grep("/NETMASK:/", array_flip($iface))));

			/* Validate the extracted data before echoing JavaScript. */
			if (!empty($ipaddr) && !empty($netmask)) {
				for ($z = 0; $z < count($ipaddr); $z++) {
					$gatewayVal = $gateway[$z] ?? '';
					$ipVal = $ipaddr[$z];
					$netmaskVal = $netmask[$z];

					/* Ensure the values are sanitized before outputting them. */
					$gatewayVal = htmlspecialchars($gatewayVal, ENT_QUOTES, 'UTF-8');
					$ipVal = htmlspecialchars($ipVal, ENT_QUOTES, 'UTF-8');
					$netmaskVal = htmlspecialchars($netmaskVal, ENT_QUOTES, 'UTF-8');

					/* Output valid JavaScript code. */
					echo "network.push({gateway: '{$gatewayVal}', ip: '{$ipVal}', netmask: '{$netmaskVal}'});\n";
				}
			}
		}
	}
	?>

	/*
		Check if SweetAlert2 library (swal2) is undefined.
		If undefined, dynamically load the required stylesheets and scripts.
	*/
	if (typeof swal2 === "undefined") {
		/* Append the SweetAlert2 stylesheet to the head of the document. */
		$('head').append($('<link rel="stylesheet" type="text/css" />').attr('href', '<?autov("/plugins/".UNASSIGNED_PLUGIN."/assets/sweetalert2.css");?>'));

		/* Load the SweetAlert2 script dynamically. */
		$.getScript('/plugins/' + udPluginPath + '/assets/sweetalert2.js');
	}
</script>

<?=$Preclear ? $Preclear->html() : "";?>

<div class='pluginUpdate'></div>

<div class='title ud'>
<div class='left'>_(Unassigned Disks)_/_(Remote Shares)_/_(Historical Unassigned Devices)_</div>
<div class='titleRight'>
<div class='right ud ud_titleFix'><a class='info'  href="/Settings/UnassignedDevicesSettings"><i class="fa fa-gear"></i><span class='help-content'><?=_('Unassigned Devices Settings')?></span></a></div>
<div class='right ud ud_titleFix'><a class='info' onclick="rescan_disks()"><i class="fa fa-refresh"></i><span class='help-content'><?=_('Refresh Disks and Configuration')?></span></a></div>
<div class='right ud ud_titleFix'><a title="_(Show/Hide Historical Unassigned Devices)_"></a><input type="checkbox" name='historical-switch' class="historical-switch"></div>
<div class='right ud ud_titleFix'><a title="_(Show/Hide SMB/NFS/ISO Shares)_"></a><input type="checkbox" name='shares-swirch' class="shares-switch"></div>
<div class='right ud ud_titleFix'><a title="_(Show/Hide Unassiged Disk Devices)_"></a><input type="checkbox" name='disks-switch' class="disks-switch"></div>
</div>
</div>

<div class='show-disks'>
	<div class='title shift'>
		<span class='left'><img src='/plugins/<?=UNASSIGNED_PLUGIN;?>/icons/disk.png' class='icon'><?=_('Unassigned Disk Devices')?></span>
	</div>

	<table id='usb_devices_list' class='usb_mounts'>
		<thead>
			<tr>
				<td><?=_('Device')?></td>
				<td><?=_('Identification')?></td>
				<td></td>
				<td><?=_('Temp')?>.</td>
				<td><?=_('Reads')?></td>
				<td><?=_('Writes')?></td>
				<td><?=_('Settings')?></td>
				<td><?=_('FS')?></td>
				<td><?=_('Size')?></td>
				<td><?=_('Used')?></td>
				<td><?=_('Free')?></td>
			</tr>
		</thead>
		<tbody id="disk-table-body">
			<tr>
				<td colspan='11'><div class='spinner'></div></td>
			</tr>
		</tbody>
	</table>
	<div class='show-shares'>
		<br><br>
	</div>
</div>

:unassgned_devices_switches_plug:
> Turn on the **Disks** switch to change the web page to show disk devices. Turn off the **Disks** switch to change the web page to hide disk devices.
>
> Turn on the **Shares** switch to change the web page to show shares. Turn off the **Shares** switch to change the web page to hide shares.
>
> Turn on the **Historical** switch to show Historical disk devices. Turn off **Historical** switch to switch back to not show Historical disk devices.
>
> Click on the <i class="fa fa-refresh"></i> icon to refresh disks and configuration.
>
> Click on the <i class="fa fa-gear"></i> icon to go to the UD Settings.
>
> You can spin a disk up or down by clicking on the disk ball <i class='fa fa-circle orb green-orb'></i>or <i class='fa fa-circle orb grey-orb'></i>indicator.  Applies to version 6.9 RC2 and later only.
>
> Click on the <i class="fa fa-gears"></i> icon to go to the Device Settings configuration.  This is where you configure a device script and certain device characteristics.
> 
> Click on the <i class="icon-nvme"></i> or <i class="fa fa-hdd-o"></i> icon to display syslog entries specific to this disk device.
>
> **Mount Point icons:**
>
> When the <i class='fa fa-pencil'></i> icon shows next to the mount point it indicates the mount point can be changed when the mount point is clicked.
>
> When the <i class='fa fa-external-link'></i> icon shows next to the mount point it indicates the clicking on the mount point will browse the files on that partition.
>
> Click on the <i class="fa fa-align-left"></i> icon to display the device script log.  This is the log specific to the device script.
>
> Click on the <i class="fa fa-check"></i> icon to perform a file system check.  BTRFS and ZFS file systems need to be mounted to do a file check.  The file check on BTRFS and ZFS file systems is a scrub.
>
> Click on the <i class="fa fa-flash"></i> icon to run your device script as if it was hot plugged.  This only applies to disk devices.
:end

<div class='show-shares'>
	<div class='title shift'>
		<span class='left'><img src='/plugins/<?=UNASSIGNED_PLUGIN;?>/icons/smbsettings.png' class='icon'><?=_('SMB Shares')?>&nbsp;|&nbsp;<img src='/plugins/<?=UNASSIGNED_PLUGIN?>/icons/nfssettings.png' class='icon'><?=_('NFS Shares')?>&nbsp;|&nbsp;<img src='/plugins/<?=UNASSIGNED_PLUGIN?>/icons/iso.png' class='icon' style='width:16px;'><?=_('ISO File Shares')?></span>
	</div>

	<table class='samba_mounts'>
		<thead>
		<tr>
			<td><?=_('Share Type')?></td>
			<td><?=_('Source')?></td>
			<td><?=_('Mount Point')?></td>
			<td></td>
			<td><?=_('Remove')?></td>
			<td></td>
			<td><?=_('Settings')?></td>
			<td></td>
			<td><?=_('Size')?></td>
			<td><?=_('Used')?></td>
			<td><?=_('Free')?></td>
		</tr>
		</thead>
		<tbody id="remotes-table-body">
			<tr>
				<td colspan='11'><div class='spinner'></div></td>
			</tr>
		</tbody>
	</table>
	<div id='remotes-buttons'>
		<button id="addSambaShare" onclick='add_samba_share()' <?=$disabled?>><?=_('Add Remote SMB')?>/<?=_('NFS Share')?></button>
		<button id="addIsoShare" onclick='add_iso_share()'><?=_('Add ISO File Share')?></button>
		<button id="addRootShareBtn" onclick='add_root_share()'><?=_('Add Root Share')?></button>
	</div>
</div>

<div class='show-disks'>
	<div class='show-historical'>
		<br><br>
		<div class='title shift'>
			<span class='left'><img src='/plugins/<?=UNASSIGNED_PLUGIN;?>/icons/historical.png' class='icon'><?=_('Historical Unassigned Devices')?></span>
		</div>

		<table class='usb_absent'>
			<thead>
			<tr>
				<td><?=_('Device')?></td>
				<td><?=_('Serial Number (Mount Point)')?></td>
				<td></td>
				<td></td>
				<td><?=_('Remove')?></td>
				<td><?=_('Settings')?></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			</thead>
			<tbody id="historical-table-body">
			</tbody>
		</table>
	</div>
</div>

:unassigned_devices_general_help_plug:
> **Unassigned Devices is called UD for short.**
>
> Hover your mouse over an any active area on the UD page and a tool tip will show you what clicking that area does.
> You can mount USB devices, sata drives, Remote SMB/NFS shares, and ISO Files with UD.  Any devices with the auto mount switch on will be mounted when the array is started.  All drives and SMB/NFS Mounts are unmounted when the array is stopped on the 'stopping_svcs' event.
> If you want to share your drive, you can turn on the Share switch.  The default for Remote SMB shares is Public read/write access.  Enable SMB Security by user in the Unassigned Devices Settings.  NFS shares are exported and access is read/write.  The export of NFS devices is enabled in the Unassigned Devices settings. You can also enable a common script that will be executed on every disk mount.  In order to share any UD device, sharing needs to be enabled in the UD Settings and the switch turned on to share the particular device.  SMB/NFS remove shares and ISO mounts are always shared.
> After entering a mount point, press &lt;Enter&gt; to save the change.
>
> Additional options are available when you click on the <i style='color:black;font-weight:bold;' class="fa fa-plus-square"></i> icon by device identification.  When the disk is unmounted, the mount point of the device can be changed.  The disk label will also be changed.  A disk can be formatted and an fsck run to check the disk.
>
> The 'Settings->Unassigned Devices' security settings for SMB and NFS must be set correctly for SMB and NFS sharing to work properly.
>
> If the mount button is grayed out for a SMB/NFS remote share, the remote server is not responding to a ping.  The remote share server must respond to a ping or UD will consider it off-line.
>
> The 'Add Root Share' button is disabled when 'Enable disk shares' is enabled and any Root Shares previously added will not mount.
>
> UD has a destructive mode that allows deleting disk partitions and formatting disks.	If Destructive Mode is not turned on in the UD Settings, you WILL NOT be able to format a disk or remove partitions.  Go the the 'Settings->Unassigned Devices' to set the destructive mode.
>
> **To format a disk:**
>
> + Destructive mode must be enabled.
> + Disk must have all partitions removed.  Unmount disk, click on the <i style='color:black;font-weight:bold;' class='fa fa-plus-square'></i> icon,, and click on all <i style='color:red;font-weight:bold;' class='fa fa-remove hdd'></i> icons to delete partitions.
> + If the disk has been precelared and shows a grayed 'Format' button, click on the <i style='color:black;font-weight:bold;' class='fa fa-plus-square'></i> icon, then click on the <i style='color:red;font-weight:bold;' class='fa fa-remove hdd'></i> icon to delete the preclear status file.
>
> **Note: A disk partitioned in UD is compatible with the array disk partitioning and can be added to the array.  Supported file formats are XFS, XFS encrypted, BTRFS, BTRFS encrypted, ZFS and ZFS encrypted.**
>
> **Encrypted Disks:**
>
> + Any disk formatted in UD that is encrypted will use the array password/passphrase and can be incorporated into the array.  Or you can set a unique password when it is formatted.  If you set a password on the disk when it is formatted, you will need to enter a disk password in Unassignd Devices->Settings for that disk.
> + Any disk that was not encrypted with the Array password/passphrase can be mounted by setting a per disk passord set in Unassigned Devices->Settings.
>
> **Unassigned devices script:**
>
> UD includes a script that is used for mounting and unmounting devices and SMB/NFS mounts. These scripts can be used from the command line or in your scripts as necessary.
>
> + '/usr/local/sbin/rc.unassigned mount autodevices' - all devices set to auto mount will be mounted.
> + '/usr/local/sbin/rc.unassigned mount autoshares' - all SMB/NFS mounts set to auto mount will be mounted.
> + '/usr/local/sbin/rc.unassigned umount auto' - all devices and SMB/NFS mounts set to auto mount will be unmounted.
> + '/usr/local/sbin/rc.unassigned umount all' - all devices and SMB/NFS mounts are unmounted in preparation for shutting down the array.
> + '/usr/local/sbin/rc.unassigned mount /dev/sdX or devX' - mount disk device.
> + '/usr/local/sbin/rc.unassigned mount name=diskname' - mount disk device by disk name.
> + '/usr/local/sbin/rc.unassigned umount /dev/sdX or devX' - unmount disk device. You can use this command in a UD script to unmount the device when the script has completed.
> + '/usr/local/sbin/rc.unassigned umount name=diskname' - unmount device by disk name.
> + '/usr/local/sbin/rc.unassigned spindown /dev/sdX or devX' - spin down disk device.
> + '/usr/local/sbin/rc.unassigned spindown name=diskname' - spin down a disk by disk name.
> + '/usr/local/sbin/rc.unassigned detach /dev/sdX or devX' - detach a USB disk device. You can use this command in a UD script to detach the device when the script has completed.
> + '/usr/local/sbin/rc.unassigned detach name=diskname' - detach a USB disk device by it's name. You can use this command in a User script to detach the device when the script has completed.
> + '/usr/local/sbin/rc.unassigned attach serial - attach a disk device. You can use this command in a script to attach a device.  The 'diskname' is not available when the disk is detached.
> + '/usr/local/sbin/rc.unassigned mount source' - where source is the SMB/NFS source.
> + '/usr/local/sbin/rc.unassigned umount source' - where source is the SMB/NFS source.
>
> Note: /dev/sdX where 'X' is the device designator.  The devX is the device name in the UD page.  If the device name is 'Dev 1', then use dev1 as the device to spin down.  Using the name=diskname is useful if you have a User Script needing to perform UD operations on a disk.
>
> Be careful using the /dev/sdX or devX designation because they can change after a reboot.  It's best to use the values passed into the UD script for sdX (DEVICE) and devX (UD_DEVICE).
:end

<script>
	/* Add diskio icon. */
	$('#tab4').on({
		click:function() {
			$('i.toggle').show('slow');
		}
	});

	/* Bind Arrive events for dynamically added 'tr' elements in the '#usb_devices_list' table. */
	$("#usb_devices_list").arrive("tr", { onceOnly: false }, function () {
		const tr = $(this);

		/* Handle toggle-hdd spans. */
		tr.find("span.toggle-hdd").off("click").on("click", function () {
			const button = $(this);
			const disk = button.attr("hdd");

			/* Prevent text selection and toggle the corresponding elements. */
			button.css("user-select", "none");
			$(".toggle-" + disk).slideToggle(0);
		});

		/* Handle mount buttons. */
		tr.find("button[role$='mount']").off("click").on("click", function () {
			const button = $(this);

			/* Perform the disk operation. */
			diskOperation(button.get(0), button.attr("role"), button.attr("device"));
		});

		/* Handle format buttons. */
		tr.find("button[role$='format']").off("click").on("click", function () {
			const button = $(this);

			/* Perform the format operation. */
			format_disk(this, button.attr("context"), button.attr("device"));
		});
	});

	$(function() {
		/* Show banners. */
		/* Check for a plugin update and show banner. */
		if ( typeof caPluginUpdateCheck === "function" ) {
			caPluginUpdateCheck("unassigned.devices.plg",{element:".pluginUpdate"});
		}

		/* Check to see if a reboot is required to upodate UD. */
		<?if (is_file("/var/state/".UNASSIGNED_PLUGIN."/reboot_required")):?>
			if (typeof showUpgrade === 'function') {
				showUpgrade('<b>Reboot is required</b> to apply Unassigned Devices update');
			}
		<?endif;?>

		/* Set page refresh interval every 3 seconds. */
		refreshTimer = window.setInterval(refreshPage, REFRESH_INTERVAL);

		/* Set ping poll interval every 15 seconds. */
		window.setInterval(pingPoll, PING_INTERVAL);

		/* Show the current diskio icon based on the current diskio cookie value. */
		if ($.cookie('diskio') === undefined) {
			<?if (version_compare($version['version'],"7.0.0", ">")):?>
			$('i.toggle').removeClass('fa-list').addClass('fa-tachometer');
			<?else:?>
			$('i.toggle').removeClass('fa-tachometer').addClass('fa-list');
			<?endif;?>
		} else {
			<?if (version_compare($version['version'],"7.0.0", ">")):?>
			$('i.toggle').removeClass('fa-tachometer').addClass('fa-list');
			<?else:?>
			$('i.toggle').removeClass('fa-list').addClass('fa-tachometer');
			<?endif;?>
		}

		/* Update the show-disks status. */
		if ($.cookie('unassigned-disks-view') == 'false') {
			$('.show-disks').slideToggle('slow');
		}

		/* Update the show-shares status. */
		if ($.cookie('unassigned-shares-view') == 'false') {
			$('.show-shares').slideToggle('slow');
		}

		/* Update the show-historical status. */
		if ($.cookie('unassigned-historical-view') == 'false') {
			$('.show-historical').slideToggle('slow');
		}

		$('.tooltip').tooltipster({ delay: 100, trigger: 'custom', triggerOpen: { mouseenter: true }, triggerClose: { click: false, scroll: true, mouseleave: true } });

		/* Add switchButton to Tab/Title bar. */
		$('.disks-switch').switchButton({
			labels_placement: "left",
			on_label: "<?=_('Disks');?>",
			off_label: "<?=_('Disks');?>",
			checked: $.cookie('unassigned-disks-view') != 'false'
		});
		$('.disks-switch').change(function() {
			$('.show-disks').slideToggle('slow');
			$.cookie('unassigned-disks-view', $('.disks-switch').is(':checked') ? 'true' : 'false', { expires: 3650, path: '/' });
		});

		$('.shares-switch').switchButton({
			labels_placement: "left",
			on_label: "<?=_('Shares');?>",
			off_label: "<?=_('Shares');?>",
			checked: $.cookie('unassigned-shares-view') != 'false'
		});
		$('.shares-switch').change(function() {
			$('.show-shares').slideToggle('slow');
			$.cookie('unassigned-shares-view', $('.shares-switch').is(':checked') ? 'true' : 'false', { expires: 3650, path: '/' });
		});

		$('.historical-switch').switchButton({
			labels_placement: "left",
			on_label: "<?=_('Historical');?>",
			off_label: "<?=_('Historical');?>",
			checked: $.cookie('unassigned-historical-view') != 'false'
		});
		$('.historical-switch').change(function() {
			$('.show-historical').slideToggle('slow');
			$.cookie('unassigned-historical-view', $('.historical-switch').is(':checked') ? 'true' : 'false', { expires: 3650, path: '/' });
		});

		/* Proxy to check for 'tab' and 'diskio' cookie changes. */
		(function() {
			const originalSetCookie = $.cookie;

			/* Proxy the $.cookie function. */
			$.cookie = function(name, value, options) {
				if (name === 'diskio') {
					/* If the 'diskio' cookie has changed, refresh the change to show the change. */
					refreshPage();
				}

				return originalSetCookie.apply(this, arguments);
			};
		})();

		refreshPage();
	});
</script>

<div style="display:none;" data-survey-name="add_root_share" data-survey-title="<?=_('Add Root Share');?>">
	<div data-question data-question-title="<?=_('Root Share')?>" data-question-button-done="<?=_('Add');?>">
		<div data-question-content>
			<p><?=_('This is a way to gather Unraid shares into one Root Share');?>.</p>
			<?if ($var['shareDisk'] != "yes"):?>
			<p><span style="font-weight:bold;"><?=_('Note');?>:</span> <?=_('Use caution when gathering shares into one Root Share');?>. <?=_('Do not put files or folders into the /mnt/rootshare/ folder');?>.
			<p><?=_('When you copy files between shares in the Root Share, the files may not end up on the expected disks');?>.</p>
			<p><?=_('You can also subject yourself to security issues like ransomware by exposing all your shares in one Root Share');?>.</p>
			<?else:?>
			<p><span style="font-weight:bold;"><?=_('Note');?>:</span> <?=_('Disk Sharing must be disabled to add a Root Share')?>.</p>
			<p><?=_('Go to Settings->Global Share Settings and set Enable Disk Shares to Auto or Off');?>.</p>
			<?endif;?>
		</div>
	</div>

	<div data-question data-question-title="<?=_('Root Share')?>" data-question-button-done="<?=_('Add');?>">
		<div data-question-content>
			<select name="PATH" class="swal-content__input">
				<option value="user"><?=_('User Shares');?></option>
				<option value="user0" <?= $isUser0 ? '' : 'disabled'; ?>><?=_('User Shares without Pools');?></option>
			</select>
			<p><?=_('Select the Root Share');?>.</p>
			<p><?=_('User Shares - allow access to User Shares, including Cache and Pool files');?>.</p>
			<p><?=_('User Shares without Pools - allow access to User Shares, but the Root Share will not include Cache and Pool files');?>.</p>
		</div>
	</div>
	<div data-question-load></div>
	<div data-survey-done>
		$.post(UDURL, {
			'action': 'add_root_share',
			'path': surveyData['PATH']
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>

	<div>
		<script>
			$(function() {
				/* Define a function add_root_share and attach it to the window object */
				window.add_root_share = function() {
					/* Call the doUnassignedDevicesSurvey function with the argument "add_root_share" */
					doUnassignedDevicesSurvey("add_root_share");
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="add_iso_share" data-survey-title="<?=_('Add ISO File Share');?>">
	<div data-question data-question-title="<?=_('Choose ISO File')?>" data-question-button-done="<?=_('Add');?>">
		<div data-question-format>
			["data-pickroot","ISO_FILE"]
		</div>
		<div data-question-content>
			<input type='text' name='{1}' placeholder="<?=_('Click to select ISO file');?>" data-pickcloseonfile='true' data-pickfilter='iso' {0}='/mnt/user/isos/' data-pickfolders='true' required class='swal-content__input' autocomplete="off" >
		</div>
		<div data-question-load></div>
		<div data-question-done>
			(surveyData["ISO_FILE"].toLowerCase().indexOf(".iso") !== -1)
		</div>
	</div>
	<div data-survey-done>
		const opts = {
			action: "add_iso_share",
			ISO_FILE: surveyData["ISO_FILE"]
		};

		if (opts.ISO_FILE) {
			$.post(UDURL, opts)
				.done(function (data) {
					swalShowResult(data === "true");
				})
				.fail(function () {
					swalShowResult(false);
				});
		}
	</div>
	<div>
		<script>
			/* Attach a click event to the input element with the name "ISO_FILE" within the document */
			$(document).on("click", "input[name=ISO_FILE]", function() {
				/* Check if the input element has no sibling with the class "fileTree" */
				if (!$(this).siblings("div.fileTree").length) {
					/* Attach the fileTree to the input element */
					$(this).fileTreeAttach();
					/* Trigger a click event on the input element */
					$(this).trigger("click");
				}
				/* Adjust styling for the next sibling div with the class "fileTree" */
				$(this)
					.next("div.fileTree")
					.css("text-align", "left")
					.css("z-index", "10001")
					.css("left", "20px")
					.css("width", $(this).width() + 13);
			});

			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function add_iso_share and attach it to the window object */
				window.add_iso_share = function() {
					/* Call the doUnassignedDevicesSurvey function with the argument "add_iso_share" */
					doUnassignedDevicesSurvey("add_iso_share");
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="format_disk" data-survey-title="<?=_('Partition and Format Disk');?>">
<?if (file_exists("/usr/sbin/parted") && get_config("Config", "destructive_mode") == "enabled"):?>
	<div data-question data-question-title="<?=_('Choose File System Format');?>">
		<div data-question-format>
			[surveyOption.device, surveyOption.type]
		</div>
		<div data-question-content>
			<select name="FS" class="swal-content__input">
				<option value="xfs">XFS</option>
				<option value="btrfs">BTRFS</option>
				<?if (version_compare($version['version'],"6.11.9", ">")):?>
				<option value="zfs">ZFS</option>
				<?endif;?>
				<option value="xfs-encrypted">XFS - encrypted</option>
				<option value="btrfs-encrypted">BTRFS - encrypted</option>
				<?if (version_compare($version['version'],"6.11.9", ">")):?>
				<option value="zfs-encrypted">ZFS - encrypted</option>
				<?endif;?>
				<option value="ntfs">NTFS</option>
				<option value="exfat">exFAT</option>
				<option value="fat32">FAT32</option>
			</select>
			<p><span style="font-weight:bold;"><?=_('Note');?>:</span> <?=_('An XFS, BTRFS, or ZFS disk partitioned in UD is compatible with the array disk partitioning and can be added to the array');?>.</p>
		</div>
		<div data-question-load></div>
		<div data-question-done></div>
	</div>

	<div data-question data-question-title="<?=_('ZFS Pool Name');?>">
		<div data-question-condition>
			surveyData['FS'] == 'zfs' || surveyData['FS'] == 'zfs-encrypted'
		</div>
		<div data-question-content>
			<div class="swal-content">
				<input type="text" class="swal-content__input" name="POOL_NAME" required placeholder="<?=_('Pool Name');?>">
				<p><?=_('Enter the Pool Name for this device');?>. <?=_('This wil also be the mountpoint for the disk');?>.</p>
			</div>
		</div>
	</div>

	<div data-question data-question-title="<?=_('Password');?>">
		<div data-question-condition>
			surveyData['FS'] == 'xfs-encrypted' || surveyData['FS'] == 'btrfs-encrypted' || surveyData['FS'] == 'zfs-encrypted'
		</div>
		<div data-question-content>
			<div class="swal-content">
				<input type="password" class="swal-content__input" name="PASS" autocomplete="off" placeholder="<?=_('Password');?>">
				<p><?=_('Enter the password to use for this disk');?>. <?=_('Leave blank to use the array password/passphrase');?>. <?=_('If using a disk password, be sure to enter the password for this disk in UD Settings so it can be mounted');?>.</p>
				<p><span style="font-weight:bold;"><?=_('Note');?>:</span> <?=_('Remember your password');?>. <?=_('It cannot be recovered');?>!</p>
			</div>
		</div>
	</div>

	<div data-question data-question-title="" data-question-button-done=<?=_('Format');?> data-question-icon="warning">
		<div data-question-format>
			[surveyOption.device, surveyOption.type]
		</div>
		<div data-question-content>
			<div class="swal-title"><?=_('Any data on this disk will be lost');?>!</div>
			<div style="margin-bottom: 25px;font-size: 20px;"><?=_('Type');?> <span class="red">'<?=_('Yes');?>'</span> <?=_('to format');?>:</div>
			<input type="text" name="confirmation" class="swal-content__input" autocomplete="off" required >
		</div>
		<div data-question-load></div>
		<div data-question-done>
			(surveyData["confirmation"] == "<?=_('Yes');?>")
		</div>
	</div>

	<div data-survey-done data-survey-done-wait="true">
		const targetButton = $("button[device='"+surveyOption.device+"']");
		targetButton.prop('disabled', true);
		targetButton.html("<i class='fa fa-spinner fa-spin'></i>" + "<?=_('Formatting');?>");

		/* Retart the page refresh timer. */
		window.clearInterval(refreshTimer);
		refreshTimer = window.setInterval(refreshPage, REFRESH_INTERVAL);

		/* Start the refresh timer to refresh the page after the mount/unmount script starts. */
		window.setTimeout(refreshPage, (REFRESH_INTERVAL / 6));

		$.post(UDURL, {
			'action': 'format_' + surveyOption.type,
			'device': surveyOption.device,
			'fs': surveyData["FS"],
			'pass': surveyData["PASS"],
			'pool_name': surveyData["POOL_NAME"]
		}, function (data) {
			targetButton.prop('disabled', true);
			targetButton.html(data.status ? "<?=_('Formatted');?>" : "<?=_('Format failed');?>");
			swalShowResult(data.status);
		}, 'json').fail(function () {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			$(function() {
				window.format_disk = function(bt, type, device){doUnassignedDevicesSurvey("format_disk", {el:bt, type:type, device:device});}
			});
		</script>
	</div>
	<?else:?>
	<div data-question data-question-title="<?=_('Partition and Format Disk');?>">
		<div data-question-content>
			<p><?=_('You must enable the Destructive Mode in UD Settings before you can Format this disk');?>.</p>
		</div>
	</div>
	<div data-survey-done data-survey-done-wait="false">
	</div>
	<?endif;?>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function format_disk and attach it to the window object */
				window.format_disk = function(bt, type, device) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "format_disk", {el:bt, type:type, device:device} */
					doUnassignedDevicesSurvey("format_disk", {el: bt, type: type, device: device});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="remove_partiton" data-survey-title="">
	<div data-question data-question-title="" data-question-button-done="<?=_('Remove');?>" data-question-icon="warning">
		<div data-question-format>
			[surveyOption.partition, surveyOption.device, surveyOption.serial]
		</div>
		<div data-question-content>
			<div class="swal-title"><?=_('Data on this disk will be lost');?>!</div>
			<div class="swal-title" style="font-size: 20px;"><?=_('Remove partition');?> <span class="red">{0}</span> <?=_('from disk');?> <span class="red">{1}?</span></div>
			<div style="margin-bottom: 25px;font-size: 20px;"><?=_('Type');?> <span class="red">'<?=_('Yes');?>'</span> <?=_('to delete this partition');?>:</div>
			<input type="text" name="confirmation" class="swal-content__input" autocomplete="off" required >
		</div>
		<div data-question-load></div>
		<div data-question-done>
			(surveyData["confirmation"] == "<?=_('Yes');?>")
		</div>
	</div>
	<div data-survey-done>
		const targetSpan = $("span[device='" + surveyOption.device + surveyOption.partition + "']");
		targetSpan.prop('disabled', true);
		targetSpan.html("<i class='fa fa-spinner fa-spin'></i> <?=_('Removing');?>");

		$.post(UDURL, {
			'action': 'remove_partition',
			'serial': surveyOption.serial,
			'device': surveyOption.device,
			'partition': surveyOption.partition
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function remove_partition and attach it to the window object */
				window.remove_partition = function(bt, serial, device, partition) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "remove_partiton", {el:bt, serial:serial, device:device, partition:partition} */
					doUnassignedDevicesSurvey("remove_partiton", {el: bt, serial: serial, device: device, partition: partition});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="clear_disk" data-survey-title="">
	<div data-question data-question-title="" data-question-button-done="<?=_('Clear');?>" data-question-icon="warning">
		<div data-question-format>
			[surveyOption.device, surveyOption.serial]
		</div>
		<div data-question-content>
			<div class="swal-title"><?=_('Data on this disk will be lost');?>!</div>
			<div class="swal-title" style="font-size: 20px;"><?=_('Clear Disk');?> <span class="red">{0}?</span></div>
			<div style="margin-bottom: 25px;font-size: 20px;"><?=_('Type');?> <span class="red">'<?=_('Yes');?>'</span> <?=_('to clear this disk of all partitions');?>:</div>
			<input type="text" name="confirmation" class="swal-content__input" autocomplete="off" required >
			<?if ($Preclear):?>
			<p><?=_('If this disk was pre-cleared, you will remove the pre-clear signature.  If you add the disk to the array and the pre-clear signature is removed, Unraid will go through the lengthy process of clearing the disk again')?>.</p>
			<?endif;?>
		</div>
		<div data-question-load></div>
		<div data-question-done>
			(surveyData["confirmation"] == "<?=_('Yes');?>")
		</div>
	</div>
	<div data-survey-done>
		const targetSpan = $("span[device='" + surveyOption.device + surveyOption.partition + "']");
		targetSpan.prop('disabled', true);
		targetSpan.html("<i class='fa fa-spinner fa-spin'></i> <?=_('Removing');?>");

		$.post(UDURL, {
			'action': 'clear_disk',
			'serial': surveyOption.serial,
			'device': surveyOption.device
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function clear_disk and attach it to the window object */
				window.clear_disk = function(bt, serial, device) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "clear_disk", {el:bt, serial:serial, device:device} */
					doUnassignedDevicesSurvey("clear_disk", {el: bt, serial: serial, device: device});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="remove_iso_share" data-survey-title="<?=_('Remove ISO File mount');?>">
	<div data-question data-question-title="" data-question-button-done="<?=_('Remove');?>" data-question-icon="warning">
		<div data-question-format>
			[surveyOption.device, surveyOption.compressed]
		</div>
		<div data-question-content>
			<div class="swal-title" style="font-size: 20px;"><?=_('This will remove the ISO file share for');?>:</div>
			<div style="margin-bottom: 15px;margin-top: 15px;">
				<span style="font-weight: bold;">{1}</span>
			</div>
			<div class="swal-title" style="font-size: 20px;">
				<span class="red" style="font-weight: bold;"><?=_('Are you sure');?>?</span>
			</div>
		</div>
		<div data-question-load></div>
		<div data-question-done></div>
	</div>
	<div data-survey-done>
		$.post(UDURL, {
			'action': 'remove_iso_config',
			'device': surveyOption.device
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function remove_iso_config and attach it to the window object */
				window.remove_iso_config = function(device, compressed) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "remove_iso_share", {device:device, compressed:compressed} */
					doUnassignedDevicesSurvey("remove_iso_share", {device: device, compressed: compressed});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="remove_disk_config" data-survey-title="<?=_('Remove Disk Config');?>">
	<div data-question data-question-title="" data-question-button-done="<?=_('Remove');?>" data-question-icon="warning">
		<div data-question-format>
			[surveyOption.serial, surveyOption.compressed]
		</div>
		<div data-question-content>
			<div class="swal-title" style="font-size: 20px;"><?=_('This will remove the saved configuration of');?>:</div>
			<div style="margin-bottom: 15px;margin-top: 15px;">
				<span style="font-weight: bold;">{1}</span>
			</div>
			<div class="swal-title" style="font-size: 20px;">
				<span class="red" style="font-weight: bold;"><?=_('Are you sure');?>?</span>
			</div>
		</div>
		<div data-question-load></div>
		<div data-question-done></div>
	</div>
	<div data-survey-done>
		$.post(UDURL, {
			'action': 'remove_config',
			'serial': surveyOption.serial
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function(){
				/* Define a function remove_disk_config and attach it to the window object */
				window.remove_disk_config = function(serial, compressed) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "remove_disk_config", {serial:serial, compressed:compressed} */
					doUnassignedDevicesSurvey("remove_disk_config", {serial: serial, compressed: compressed});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="remove_remote_share" data-survey-title="<?=_('Remove SMB/NFS mount');?>?">
	<div data-question data-question-title="" data-question-button-done="<?=_('Remove');?>" data-question-icon="warning">
		<div data-question-format>
			[surveyOption.device, surveyOption.compressed, surveyOption.type]
		</div>
		<div data-question-content>
			<div class="swal-title" style="font-size: 20px;"><?=_('This will remove the');?> <span style="font-weight: bold;">{2}</span> <?=_('share for');?>:</div>
			<div style="margin-bottom: 15px;margin-top: 15px;">
				<span style="font-weight: bold;">{1}</span>
			</div>
			<div class="swal-title" style="font-size: 20px;">
				<span class="red" style="font-weight: bold;"><?=_('Are you sure');?>?</span>
			</div>
		</div>
		<div data-question-load></div>
		<div data-question-done></div>
	</div>
	<div data-survey-done>
		$.post(UDURL, {
			'action': 'remove_samba_config',
			'device': surveyOption.device
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function(){
				/* Define a function remove_samba_config and attach it to the window object */
				window.remove_samba_config = function(device, compressed, type) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "remove_remote_share", {device:device, compressed:compressed, type:type} */
					doUnassignedDevicesSurvey("remove_remote_share", {device: device, compressed: compressed, type: type});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="add_remote_share" data-survey-title="<?=_('Add Remote Share');?>">
	<div data-question data-question-title="<?=_('Click on Icon to Choose Protocol');?>">
		<div data-question-format>
			["nfs_radio","smb_radio"]
		</div>
		<div data-question-content>
			<div class="image-radio">
				<input type="radio" id="{0}" name="PROTOCOL" value="NFS" required="" <?=($var['shareNFSEnabled']=="no") ? "disabled" : "";?>>
				<label class="image-radio-label image-radio-linux" for="{0}" title="<?=_('Click to select NFS');?>"></label>
				<input type="radio" id="{1}" name="PROTOCOL" value="SMB" required="" <?=($var['shareSMBEnabled']=="no") ? "disabled" : "";?>>
				<label class="image-radio-label image-radio-windows" for="{1}" title="<?=_('Click to select SMB');?>"></label>
				<p><?=_('WARNING').": "._('Use caution when using a remote share local mount in a Docker Container or VM for critical data');?>.  <?=_('Media mapped to apps like Plex should not be a problem');?>.  <?=_('Remote share mounts are dependent on a solid and reliable network connection and that can be difficult to achieve');?>. <?=_('If the remote share goes offline, you may have problems');?>!</p>
				<?if ($var['shareNFSEnabled']=="no"):?><p><?=_('Note').": "._('You must enable NFS in Settings->NFS to mount NFS shares').".";?></p><?endif;?>
				<?if ($var['shareSMBEnabled']=="no"):?><p><?=_('Note').": "._('You must enable SMB in Settings->SMB to mount SMB shares').".";?></p><?endif;?>
			</div>
		</div>
	</div>
<?
	$message  = "<p>"._('Search for Servers, or enter the Server name or IP address manually')."</p>";
	$message .= "<p>"._('If the IP address of the server shows in the list after searching, your DNS server is not resolving the name')."</p>";
	$message .= "<p>"._('Enter the server name and it will be added to the local DNS names and will then resolve by name')."</p>";
?>
	<div data-question data-question-title="<?=_('Choose NFS Server');?>">
		<div data-question-condition>
			surveyData['PROTOCOL'] == 'NFS';
		</div>
		<div data-question-format>
			["list_nfs_hosts"]
		</div>
		<div data-question-content>
			<input type="text" class="swal-content__input" name="IP" autocomplete="off" required placeholder="<?=_('Enter or Select Server');?>"><br>
			<button class="swal-button" onclick='loadHosts(this,"{0}")'><?=_('Search For Servers');?></button>
			<?=$message;?>
		</div>
	</div>
	<div data-question data-question-title="<?=_('Choose SMB Server');?>">
		<div data-question-condition>
			surveyData['PROTOCOL'] == 'SMB';
		</div>
		<div data-question-format>
			["list_samba_hosts"]
		</div>
		<div data-question-content>
			<input type="text" class="swal-content__input" name="IP" autocomplete="off" required placeholder="<?=_('Enter or Select Server');?>"><br>
			<button class="swal-button" onclick='loadHosts(this,"{0}")'><?=_('Search For Servers');?></button>
			<?=$message;?>
		</div>
	</div>
	<div data-question data-question-title="<?=_('Username');?>">
		<div data-question-condition>
			surveyData['PROTOCOL'] == 'SMB';
		</div>
		<div data-question-content>
			<div class="swal-content">
				<input type="text" class="swal-content__input" name="USER" autocomplete="off" placeholder="<?=_('Username');?>">
				<p><?=_('Enter the Username if the share is password protected');?>.</p>
				<p><?=_('You will need to enter credentials to list the shares');?>.</p>
			</div>
		</div>
	</div>
	<div data-question data-question-title="<?=_('Password');?>">
		<div data-question-condition>
			surveyData['PROTOCOL'] == 'SMB'
		</div>
		<div data-question-content>
			<div class="swal-content">
				<input type="password" class="swal-content__input" name="PASS" autocomplete="new-password" placeholder="<?=_('Password');?>">
				<p><?=_('Enter the Password if the share is password protected');?>.</p>
				<p><?=_('You will need to enter credentials to list the shares');?>.</p>
			</div>
		</div>
	</div>
	<div data-question data-question-title="<?=_('Domain');?>">
		<div data-question-condition>
			surveyData['PROTOCOL'] == 'SMB'
		</div>
		<div data-question-content>
			<div class="swal-content">
				<input type="text" class="swal-content__input" name="DOMAIN" autocomplete="off" placeholder="<?=_('Domain');?>">
				<p><?=_('Enter the Domain for the share if on a Domain');?>.</p>
			</div>
		</div>
	</div>
	<div data-question data-question-title="<?=_('Choose Share');?>">
		<div data-question-format>
			[surveyData['PROTOCOL'], surveyData['IP'], surveyData['USER'], surveyData['PASS'], surveyData['DOMAIN'], (surveyData['PROTOCOL'] == 'SMB' ? 'list_samba_shares' : 'list_nfs_shares')]
		</div>
		<div data-question-content>
			<input type='text' class="swal-content__input" autocomplete="off" name='SHARE' required placeholder="<?=_('Enter or Select Share');?>"><br>
			<button class="swal-button" onclick='loadShares(this, "{1}", "{2}", "{3}", "{5}")'><?=_('Load Shares');?></button>
			<p><?=_('Search for Shares or enter the Share name manually');?>.</p>
			<p><?=_('If SMB shares do not show, check your credentials');?>.</p>
		</div>
	</div>
	<div data-survey-done>
		const opts = {
			action: "add_samba_share",
			PROTOCOL: surveyData['PROTOCOL'],
			IP: surveyData['IP'],
			USER: surveyData['USER'],
			DOMAIN: surveyData['DOMAIN'],
			PASS: surveyData['PASS'],
			SHARE: surveyData['SHARE']
		};

		if (opts.SHARE && opts.IP) {
			$.post(UDURL, opts)
				.done(function (data) {
					swalShowResult(data === "true");
				})
				.fail(function () {
					swalShowResult(false);
				});
		}
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function(){
				/* Define a function add_samba_share and attach it to the window object */
				window.add_samba_share = function(i) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "add_remote_share", i */
					doUnassignedDevicesSurvey("add_remote_share", i);
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="change_mountpoint" data-survey-title="">
	<div data-question data-question-title="<?=_('Change Disk Mount Point');?>" data-question-button-done="<?=_('Change');?>">
		<div data-question-format>
			[surveyOption.mountpoint, surveyOption.disklabel]
		</div>
		<div data-question-content>
			<input type="text" class="swal-content__input" name="MOUNTPOINT" value={0} placeholder="<?=_('Mount Point');?>">
			<p><?=_('Disk Label');?>:&nbsp;{1}</p>
			<p><?=_('Changing the Mount Point will also change the disk label on all disks and the pool name on a ZFS disk');?>.</p>
		</div>
		<div data-question-load></div>
	</div>
	<div data-survey-done data-survey-done-wait="true">
		$.post(UDURL, {
			'action': 'change_mountpoint',
			'serial': surveyOption.serial,
			'partition': surveyOption.partition,
			'device': surveyOption.device,
			'fstype': surveyOption.fstype,
			'mountpoint': encodeURIComponent(surveyData['MOUNTPOINT'])
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function change_mountpoint and attach it to the window object */
				window.change_mountpoint = function(serial, partition, device, fstype, mountpoint, disklabel) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "change_mountpoint" and an object containing the specified parameters */
					doUnassignedDevicesSurvey("change_mountpoint", {
						serial: serial,
						partition: partition,
						device: device,
						fstype: fstype,
						mountpoint: mountpoint,
						disklabel: disklabel
					});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="change_samba_mountpoint" data-survey-title="">
	<div data-question data-question-title="<?=_('Change SMB/NFS Mount Point');?>" data-question-button-done="<?=_('Change');?>">
		<div data-question-format>
			[surveyOption.mountpoint]
		</div>
		<div data-question-content>
			<input type="text" class="swal-content__input" name="MOUNTPOINT" value={0} placeholder="<?=_('Mount Point');?>" required>
		</div>
		<div data-question-load></div>
		<div data-question-done></div>
	</div>
	<div data-survey-done data-survey-done-wait="true">
		$.post(UDURL, {
			'action': 'change_samba_mountpoint',
			'device': surveyOption.device,
			'mountpoint': encodeURIComponent(surveyData['MOUNTPOINT'])
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function change_samba_mountpoint and attach it to the window object */
				window.change_samba_mountpoint = function(device, mountpoint) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "change_samba_mountpoint" and an object containing the specified parameters */
					doUnassignedDevicesSurvey("change_samba_mountpoint", {
						device: device,
						mountpoint: mountpoint
					});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="change_iso_mountpoint" data-survey-title="">
	<div data-question data-question-title="<?=_('Change ISO File Mount Point');?>" data-question-button-done="<?=_('Change');?>">
		<div data-question-format>
			[surveyOption.mountpoint]
		</div>
		<div data-question-content>
			<input type="text" class="swal-content__input" name="MOUNTPOINT" value={0} placeholder="<?=_('Mount Point');?>" required>
		</div>
		<div data-question-load></div>
		<div data-question-done></div>
	</div>
	<div data-survey-done data-survey-done-wait="true">
		$.post(UDURL, {
			'action': 'change_iso_mountpoint',
			'device': surveyOption.device,
			'mountpoint': encodeURIComponent(surveyData['MOUNTPOINT'])
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function change_iso_mountpoint and attach it to the window object */
				window.change_iso_mountpoint = function(device, mountpoint) {
					/* Call the doUnassignedDevicesSurvey function with the arguments "change_iso_mountpoint" and an object containing the specified parameters */
					doUnassignedDevicesSurvey("change_iso_mountpoint", {
						device: device,
						mountpoint: mountpoint
					});
				};
			});
		</script>
	</div>
</div>

<div style="display:none;" data-survey-name="rescan_disks" data-survey-title="">
	<div data-question data-question-title="" data-question-button-done="<?=_('Proceed');?>" data-question-icon="warning">
		<div data-question-content>
			<p><?=_('Refresh Disks and Configuration');?>?</p>
			<ul>
			<li style="text-align:left;"><?=_('All disks will be refreshed using udev');?>.</li>
			<li style="text-align:left;"><?=_('Remote Shares online status will be reset');?>.</li>
			<li style="text-align:left;"><?=_('All Unassigned Devices configurations will be updated from flash drive');?>.</li>
			</ul>
		</div>
		<div data-question-load></div>
		<div data-question-done></div>
	</div>
	<div data-survey-done>
		$.post(UDURL, {
			'action': 'rescan_disks',
		})
		.done(function(data) {
			swalShowResult(data === "true");
		}, 'json')
		.fail(function() {
			swalShowResult(false);
		});
	</div>
	<div>
		<script>
			/* Execute a function when the document is ready */
			$(function() {
				/* Define a function rescan_disks and attach it to the window object */
				window.rescan_disks = function() {
					/* Call the doUnassignedDevicesSurvey function with the arguments "rescan_disks"} */
					doUnassignedDevicesSurvey("rescan_disks");
				};
			});
		</script>
	</div>
</div>
